<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>クラフト素材計算</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --card2:#0f1521;
      --text:#e7eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --accent:#6ea8fe;
      --good:#37d67a;
      --warn:#ffcc66;
      --chip:rgba(110,168,254,.14);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(110,168,254,.18), transparent 60%),
                  radial-gradient(900px 600px at 110% 20%, rgba(55,214,122,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:20px 20px 10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(11,15,20,.86); backdrop-filter: blur(10px);
      z-index:10;
    }
    h1{margin:0 0 6px; font-size:20px;}
    .sub{color:var(--muted); font-size:12px; margin:0;}

    .wrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 60%), var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 14px 10px;
      font-size:14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .content{padding:14px;}

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding:14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 70%), var(--card2);
    }
    .seg{
      display:flex;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px;
      gap:4px;
      overflow:auto;
    }
    .seg button{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
      font-size:12px;
    }
    .seg button.active{
      background:rgba(110,168,254,.18);
      color:var(--text);
      outline:1px solid rgba(110,168,254,.35);
    }

    .search{
      flex:1;
      min-width:180px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .search input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .chip input{transform: translateY(1px);}

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .row{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(255,255,255,.02);
      display:grid;
      grid-template-columns: 1fr 140px;
      gap:10px;
      align-items:center;
      transition:.15s ease;
    }
    .row:hover{transform: translateY(-1px); background:rgba(255,255,255,.03);}
    .row.entered{
      background:rgba(55,214,122,.10);
      border-color: rgba(55,214,122,.35);
    }
    .row .name{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .star{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      flex:0 0 auto;
    }
    .star.on{
      color: var(--warn);
      background:rgba(255,204,102,.10);
      border-color: rgba(255,204,102,.30);
    }

    .icon{
      width:56px;
      height:56px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      object-fit:contain;
      padding:6px;
      flex:0 0 auto;
    }

    .titleWrap{min-width:0;}
    .title{
      font-weight:700;
      font-size:13px;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{
      margin-top:4px;
      color:var(--muted);
      font-size:11px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid rgba(110,168,254,.25);
      color:var(--text);
      font-size:11px;
    }

    .row input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-size:14px;
      text-align:right;
    }

    .secTitle{
      margin:0 0 10px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.02em;
    }
    .kv{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 0;
      border-bottom:1px dashed rgba(255,255,255,.12);
      gap:10px;
      font-size:13px;
    }
    .kv:last-child{border-bottom:0;}
    .yen{color:var(--warn); font-weight:800;}
    .muted{color:var(--muted); font-size:12px;}

    .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
      margin-top:12px;
    }
    details{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.02);
      padding:10px;
      margin-top:10px;
    }
    summary{
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      color:var(--text);
      list-style:none;
    }
    summary::-webkit-details-marker{display:none;}
    .opt{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    .opt .muted{margin-top:4px;}
    .opt ul{margin:8px 0 0; padding-left:18px;}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; }
      .row{grid-template-columns: 1fr 120px;}
      .icon{width:36px;height:36px;padding:5px;}
    }
  
    /* ===== 犯罪名の前につけるカラー丸（●） ===== */
    .crime-dot{
      font-size: 14px;
      margin-right: 6px;
      line-height: 1;
    }

    .crime-dot.small{ color:#3b82f6; } /* 青 */
    .crime-dot.mid{   color:#f59e0b; } /* オレンジ */
    .crime-dot.large{ color:#ef4444; } /* 赤 */
    .crime-dot.gig{   color:#a855f7; } /* 紫 */


    .tabs{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .tab{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.02em;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      background: rgba(110,168,254,.18);
      border-color: rgba(110,168,254,.35);
    }
    .hidden{ display:none !important; }
    #crimeItems .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    #crimeItems .item .meta{ display:flex; flex-direction:column; gap:4px; }
    #crimeItems .item .qty{ font-weight:800; font-size:14px; }

    /* 必要条件NOTE用 */
    .note-box{
    border:1px solid rgba(255,204,102,.25);
    background:rgba(255,204,102,.05);
    }

    .note-text{
    font-size:13px;
    line-height:1.6;
    color:#ffcc66;
    }

    /* ===== 犯罪プリセットUI統一 ===== */

    /* 行レイアウト（1行目・2行目） */
    .crimeRow{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    /* select統一サイズ */
    .crimeSelect{
      width:200px;
      height:34px;
      padding:4px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      font-size:13px;
    }

    /* 方法select：非表示でも幅維持 */
    .crimeMethod.hidden{
      visibility:hidden;
    }

    /* 回数入力統一 */
    .crimeInput{
      width:80px;
      height:34px;
      padding: 0 10px;
      text-align:center;

      border-radius:12px;              /* ←角丸 */
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:13px;
    }

    /* チップ高さ統一（犯罪ページ内だけ） */
    #crimePage .toolbar .chip{
      height:34px; /* ←後段で34pxにしてるならここも34に統一 */
      display:inline-flex;
      align-items:center;
    }

    /* 犯罪ツールバー内のchip文字を少し大きく */
    #crimePage .toolbar .chip{
      font-size:14px;
      padding:6px 10px;   /* 文字大きくした分だけ余白も微調整 */
    }

    /* 犯罪ツールバーのselectとinputの文字サイズを大きく */
    #crimePage .toolbar select,
    #crimePage .toolbar input{
      font-size:14px;
    }

    /* select / input / chip の高さと見た目を完全統一 */
    #crimePage .toolbar select,
    #crimePage .toolbar input,
    #crimePage .toolbar .chip{
      height:34px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
    }

    /* 数字入力の見た目をchipと統一 */
    #crimePage .toolbar input[type="number"]{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--text);
      padding:0 10px;
    }

    /* selectの背景統一 */
    #crimePage .toolbar select{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      padding:0 10px;
    }

    /* =========================
   犯罪ページ：必要道具一覧の見た目改善
      ========================= */
      #crimeItems .item{
        padding:10px 12px;
        border:1px solid rgba(255,255,255,.10);
        border-radius:14px;
        background:rgba(255,255,255,.02);
      }

      #crimeItems .item:hover{
        background:rgba(255,255,255,.035);
      }

      /* 左側（アイテム名＋カテゴリ） */
      #crimeItems .item .meta{
        gap:6px;
      }

      /* アイテム名：大きく・太く */
      #crimeItems .item .name{
        font-size:14px;
        font-weight:800;
        color:var(--text);
      }

      /* 下のカテゴリ（クラフト台）：小さく・薄く */
      #crimeItems .item .muted{
        font-size:11px;
        color:var(--muted);
        opacity:.9;
      }

      /* 右側の個数：中央寄せ＆大きく、右寄りすぎを解消 */
      #crimeItems .item .qty{
        min-width:54px;
        text-align:center;        /* ←右寄せやめる */
        font-size:16px;
        font-weight:900;
        color:var(--warn);
        padding:6px 10px;
        border-radius:12px;
        background:rgba(255,204,102,.08);   /* 薄い色付き */
        border:1px solid rgba(255,204,102,.22);
      }

      /* ===== クラフトツリー ===== */

        .tree{
          font-size:13px;
          line-height:1.6;
        }

        .tree details{
          margin-left:10px;
          border-left:1px dashed rgba(255,255,255,.15);
          padding-left:10px;
        }

        .tree summary{
          cursor:pointer;
          font-weight:600;
        }

        .tree .treeItem{
          display:flex;
          justify-content:space-between;
          gap:10px;
        }

        .tree .treeQty{
          color:#6ea8fe;
          font-weight:700;
        }
        
  </style>
</head>
<body>
<header>
  <h1>クラフト素材計算</h1>
  <p class="sub">カテゴリ→アイテム選択→回数入力。必要素材と料金、スーパー購入コストをまとめて出します。</p>
  <div class="tabs">
    <button id="tabCraft" class="tab active" type="button">クラフト計算</button>
    <button id="tabCrime" class="tab" type="button">犯罪に必要な道具一覧</button>
  </div>
</header>

<div id="craftPage" class="wrap">
  <!-- LEFT -->
  <div class="card">
    <div class="toolbar">

      <!-- 1行目：カテゴリ -->
      <div class="toolbar-row toolbar-row-1">
        <div class="seg" id="categorySeg"></div>
      </div>

      <!-- 2行目：検索 -->
      <div class="toolbar-row toolbar-row-2">
        <div class="search">
          <input id="searchBox" placeholder="検索（例：バッグ / 弾 / ドリル）">
        </div>
      </div>

      <!-- 3行目：チェックボックスとボタン -->
      <div class="toolbar-row toolbar-row-3">
        <label class="chip">
          <input id="showOnlyFav" type="checkbox"> お気に入りだけ
        </label>

        <label class="chip">
          <input id="showOnlyEntered" type="checkbox"> 入力中だけ表示
        </label>

        <label class="chip">
          <input id="pinEntered" type="checkbox"> 入力済みを上へ
        </label>

        <button id="resetBtn" class="chip">入力リセット</button>
      </div>

    </div>

    <div class="content">
      <div id="items" class="list"></div>
      <div class="hint">※ 数値は「クラフト回数」です（出来上がり数は yield 反映）</div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h2>
      <span>結果</span>
      <span class="muted" id="resultNote"></span>
    </h2>

    <div class="content">
      <div class="box">
        <div class="secTitle">必要素材（合計）</div>
        <div id="materials"></div>
      </div>

      <div class="box" id="craftTreeBox">
          <div class="secTitle">クラフト内訳（ツリー）</div>
          <div id="craftTree" class="tree"></div>
      </div>

      <div class="box">
        <div class="secTitle">料金合計（クラフト料金）</div>
        <div class="kv"><span>合計</span><b class="yen" id="totalYen">0円</b></div>
        <div class="muted" id="yenBreakdown"></div>
      </div>

      <div class="box">
        <div class="secTitle">スーパー購入合計</div>

        <div class="kv"><span>材料を全部買う場合</span><b class="yen" id="shopMatsTotal">0円</b></div>
        <div class="muted" id="shopMatsBreakdown"></div>

        <div style="height:10px;"></div>

        <div class="kv"><span>入力した完成品を買う場合</span><b class="yen" id="shopItemsTotal">0円</b></div>
        <div class="muted" id="shopItemsBreakdown"></div>
      </div>

      <details id="altDetails">
        <summary>代替レシピ（手動で選択できます）</summary>
        <div id="altBreakdowns"></div>
      </details>
    </div>
  </div>
</div>



<!-- CRIME PAGE -->
<div id="crimePage" class="wrap hidden">
  <!-- LEFT -->
  <div class="card">
    <div class="toolbar">

  <!-- タイトル -->
  <div class="seg" style="display:flex; align-items:center; padding:6px 12px;">
    <div class="title" style="margin:0;">犯罪プリセット</div>
  </div>

  <!-- 1行目：プリセット選択 -->
  <div class="crimeRow">
    <span id="crimeDotPreview" class="crime-dot mid">●</span>

    <select id="crimeSelect" class="crimeSelect"></select>

    <!-- 方法は常に場所を確保（hiddenでも幅維持） -->
    <select id="crimeMethod" class="crimeSelect crimeMethod"></select>
  </div>

  <!-- 2行目：回数・チェック・ボタン -->
  <div class="crimeRow">
    <input id="crimeTimes" class="crimeInput" type="number" min="1" step="1" value="1"/>

    <label class="chip"><input id="crimeIncludeMaterials" type="checkbox" checked /> 素材も含める</label>

    <label class="chip"><input id="crimeSingleMode" type="checkbox" checked /> 単体モード</label>

    <button id="addCrimeBtn" class="chip" type="button">（複数用）追加</button>

    <button id="clearCrimeBtn" class="chip" type="button">セットクリア</button>

    <button id="applyCrimeToCraftBtn" class="chip" type="button">クラフトへ反映</button>

    <button id="applyCrimeToCraftAddBtn" class="chip" type="button">追加で反映</button>

  </div>

  <!-- 注意文 -->
  <div class="hint">
    ※ 「回数」は <b>人数分（バッグなど）</b> を増やしたい時にも使えます。
  </div>

</div>


    <div class="content">
      <div id="crimeItems" class="list"></div>
      <div class="hint">※ ここは必要な道具/素材だけを一覧表示する専用ページです。</div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h2><span>犯罪セット</span><span class="muted">（選択中の内容）</span></h2>
    <div class="content">
      <div class="box">
        <div class="secTitle">必要道具（合計）</div>
        <div id="crimePlan" class="muted">（まだ追加がありません）</div>
      </div>

      <details open>
        <summary>使い方</summary>
        <div class="muted" style="margin-top:10px; line-height:1.8;">
          ① 上で犯罪を選ぶ → ② 回数を入れる（例：回収者人数） → ③ 左に必要な道具/素材が出ます。<br/>
          「素材も含める」をONにすると、道具の素材まで自動で展開して表示します（RECIPESがあるもののみ）。<br/>
          「単体モード」ONなら、犯罪を切り替えるだけで内容が入れ替わります。<br/>
          複数犯罪を合算したい時だけ「（複数用）追加」を使ってください。
        </div>
      </details>
    </div>
  </div>
</div>

<script>
  /* =======================
  データ
  ======================= */
  const CATEGORIES = [
    "違法物クラフト台",
    "ガンスミスワークベンチ",
    "化学作業台",
    "薬物製造台",
    "合鍵作成台"
  ];

  const RECIPES = {
  //========================
  // 違法物クラフト台
  //========================
  "犯罪用小型C4爆弾": { "アルミ粉": 1 },
  "小型サーマルドリル": { "ダイヤモンドドリルビット": 2 },
  "犯罪用小型テルミット爆弾": { "アルミ粉": 1 },
  "小型バッグ": { "布": 20, "小型ロープ": 3 },
  "貴金属": { }, // ALTで展開
  "小型ドリル": { "ダイヤモンドドリルビット": 1 },
  "手錠の鍵": { "鉄のインゴット": 3 },
  "ビジネスバッグ用ロックピッカー": { "鉄のインゴット": 3 },
  "犯罪用USBメモリ 1.0": { "電子キット": 1 },
  "ロックピック": { "鉄のインゴット": 1 },
  "電子キット": { "貴金属": 1, "銅のインゴット": 1 }, // ALTもあり
  "犯罪用ノートパソコングレード1": { "電子キット": 1 },
  "小型グラインダー": { "メタルブレード": 1 },

  "ダイヤモンドドリルビット": { "ダイヤモンド": 40 },
  "犯罪用USBメモリ 2.0": { "電子キット": 2, "金属接合剤": 5 },
  "犯罪用USBメモリ 3.0": { "万能接合剤": 1, "電子キット": 50 }, // 追加（電子機器系の流れに合わせて上へ寄せてもOK）

  "犯罪用ノートパソコングレード2": { "電子キット": 1, "金属接合剤": 5 },
  "犯罪用ノートパソコングレード3": { "万能接合剤": 1, "電子キット": 50 }, // 追加（スペース無しに統一）

  "犯罪用のバール": { "鋼鉄のインゴット": 1, "金属接合剤": 5 },
  "犯罪用中型C4爆弾": { "アルミ粉": 2, "金属接合剤": 5 },
  "犯罪用中型カッター": { "鋼鉄のインゴット": 1, "金属接合剤": 5 },
  "犯罪用中型テルミット爆弾": { "アルミ粉": 2, "金属接合剤": 5 },
  "犯罪用中型ドリル": { "ダイヤモンドドリルビット": 2, "金属接合剤": 5 },

  "犯罪用大型C4爆弾": { "アルミ粉": 10, "万能接合剤": 2 },
  "犯罪用大型テルミット爆弾": { "アルミ粉": 50, "万能接合剤": 1 }, // 追加

  "犯罪用大型カッター": { "万能接合剤": 1, "鋼鉄のインゴット": 30 }, // 追加
  "犯罪用大型サーマルドリル": { "万能接合剤": 1, "鋼鉄のインゴット": 30 }, // 追加
  "犯罪用大型ドリル": { "ダイヤモンドドリルビット": 3, "万能接合剤": 1 }, // 追加

  "犯罪用大型バッグ": { "布": 20 },
  "犯罪用中型バッグ": { "布": 1, "金属接合剤": 5 },

  "中型ロープ": { "小型ロープ": 1, "金属接合剤": 5 }, // 追加

  //========================
  // ガンスミス
  //========================
  "フラッシュバン": { "メテオライトインゴット": 1, "銅のインゴット": 1, "鋼鉄のインゴット": 1 },
  "ポータブルEMPデバイス": { "銅のインゴット": 2, "鋼鉄のインゴット": 1, "電子キット": 1 },
  "グレネード": { "銅のインゴット": 1, "鋼鉄のインゴット": 1 },
  "ピストル": { "ピストルボディ": 1, "鉄のバネ": 5 },
  "頑丈な防弾チョッキ": { "布": 30, "カーボンファイバー": 30, "貴金属": 5 },
  "Micro SMG": { "SMGボディ": 1, "鉄のバネ": 5, "鉄の歯車": 1 },
  ".45 ACP弾": { "鋼鉄のインゴット": 6 },
  "9mm弾": { "鋼鉄のインゴット": 3 },
  "5.56mm弾": { "鋼鉄のインゴット": 6 }, // 追加（yieldはMETAで100）
  "サプレッサー": { "カーボンファイバー": 5, "グラスファイバー": 10, "鉄のインゴット": 10 },
  "スモークグレネード": { "メテオライトインゴット": 1, "銅のインゴット": 2, "鋼鉄のインゴット": 1 },
  "タクティカルサプレッサー": { "カーボンファイバー": 5, "グラスファイバー": 10, "鉄のインゴット": 10 },
  "フラッシュライト": { "グラスファイバー": 10, "電子キット": 5 },

  "Bullpup Rifle MK2": { "アサルトライフルボディ": 1, "カーボンファイバー": 10, "グラスファイバー": 10, "金属接合剤": 3 }, // 追加
  "EMP round": { "鋼鉄のインゴット": 1, "電子キット": 1 }, // 追加
  "SMG用拡張マガジン": { "ダイヤモンド": 1, "メテオライトインゴット": 2, "電子キット": 5 }, // 追加

  //========================
  // 化学作業台
  //========================
  "バックパックLv2": { "布": 5, "小型バッグ": 10 },
  "化学薬品クラフトテーブル": { "アサルトライフルボディ": 20, "ダイヤモンド": 50 },
  "油": { }, // ALT
  "メタルブレード": { "鉄のインゴット": 1, "鋼鉄のインゴット": 1 },
  "医療キット": { "布": 1, "ライム": 1, "鋼鉄のインゴット": 1 },
  "鉄の歯車": { "鉄のインゴット": 2, "鋼鉄のインゴット": 1 },
  "バックパックLv1": { "布": 1, "小型バッグ": 1 },
  "スプレーリムーバー": { "布": 2 },
  "スプレー": { "エメラルド": 1, "サファイア": 1 },
  "車両引き換えゴールドチケット": { "車両ガチャの破片": 30 },
  "万能接合剤": { "ダイヤモンド": 100, "金属接合剤": 5 },
  "ダッフルバッグ": { "布": 10, "エメラルド": 80, "小型バッグ": 30, "小型ロープ": 10 },
  "電子機器クラフトテーブル": { "アサルトライフルボディ": 20, "ダイヤモンド": 50 },
  "ダイヤモンド": { "未加工ダイヤモンド": 5 }, // yield 5
  "金属接合剤": { "ダイヤモンド": 30 },
  "包帯": { "布": 1 },
  "SMGボディ": { }, // ALT
  "ボイステープ": { "電子キット": 1 },
  "ピストルボディ": { "カーボンファイバー": 25 },
  "グラスファイバー": { "ガラス": 1 },
  "武器クラフトテーブル": { "アサルトライフルボディ": 20, "ダイヤモンド": 50 },
  "サボテンクリーム": { "サボテンの果実": 1 },
  "弾薬バッグ": { "布": 10, "小型バッグ": 10 },
  "鉄のバネ": { "鉄のインゴット": 1, "鋼鉄のインゴット": 2 },
  "お着替えバッグ": { "布": 20, "小型バッグ": 1 },

  //========================
  // 薬物製造台
  //========================
  "【麻薬】ブルーアウト": { "ブルーフラワー": 1, "金のインゴット": 1 },
  "【麻薬】レッドスペクター": { "レッドフラワー": 1, "銅のインゴット": 1 },
  "【麻薬】ホワイトマッド": { "ホワイトフラワー": 1, "銀のインゴット": 1 },

  //========================
  // 合鍵作成台
  //========================
  "宝石店の合鍵": { "犯罪用ノートパソコングレード2": 1, "犯罪用中型テルミット爆弾": 1, "貴金属": 1, "金属接合剤": 1 },
  "204号室の鍵": { "万能接合剤": 2, "犯罪用大型C4爆弾": 1, "犯罪用大型ドリル": 1 },
  };


  const IMAGE_MAP = {
  //========================
  // 違法物クラフト台
  //========================
  "犯罪用小型C4爆弾": "c4_small.png",
  "小型サーマルドリル": "thermal_drill_small.png",
  "犯罪用小型テルミット爆弾": "thermite_small.png",
  "小型バッグ": "small_bag.png",
  "小型ドリル": "drill_small.png",
  "手錠の鍵": "handcuff_key.png",
  "ビジネスバッグ用ロックピッカー": "lockpick.png",
  "犯罪用USBメモリ 1.0": "crime_usb_1.png",
  "ロックピック": "lockpick.png",
  "電子キット": "electronic_kit.png",
  "犯罪用ノートパソコングレード1": "crime_laptop_g1.png",
  "小型グラインダー": "grinder_small.png",
  "貴金属": "Precious Metal.png",
  "ダイヤモンドドリルビット": "diamond_drill_bit.png",

  "犯罪用USBメモリ 2.0": "crime_usb_memory_2_0.png",
  "犯罪用USBメモリ 3.0": "crime_usb_3_0.png", // 追加

  "犯罪用ノートパソコングレード2": "crime_laptop_grade_2.png",
  "犯罪用ノートパソコングレード3": "crime_laptop_grade_3.png", // 追加

  "犯罪用のバール": "crime_crowbar.png",
  "犯罪用中型C4爆弾": "crime_c4_charge_medium.png",
  "犯罪用中型カッター": "crime_cutter_medium.png",
  "犯罪用中型テルミット爆弾": "crime_thermite_charge_medium.png",
  "犯罪用中型ドリル": "crime_drill_medium.png",

  "犯罪用大型C4爆弾": "crime_c4_charge_large.png",
  "犯罪用大型テルミット爆弾": "crime_thermite_large.png", // 追加
  "犯罪用大型カッター": "crime_cutter_large.png", // 追加
  "犯罪用大型サーマルドリル": "crime_thermal_drill_large.png", // 追加
  "犯罪用大型ドリル": "crime_drill_large.png", // 追加

  "犯罪用大型バッグ": "crime_bag_large.png",
  "犯罪用中型バッグ": "crime_bag_medium.png",
  "中型ロープ": "rope_medium.png", // 追加

  //========================
  // ガンスミスワークベンチ
  //========================
  "フラッシュバン": "flashbang.png",
  "ポータブルEMPデバイス": "emp_portable.png",
  "グレネード": "grenade.png",
  "ピストル": "pistol.png",
  "頑丈な防弾チョッキ": "heavy_armor.png",
  "Micro SMG": "micro_smg.png",

  ".45 ACP弾": "ammo_45acp.png",
  "9mm弾": "ammo_9mm.png",
  "5.56mm弾": "ammo_556mm.png", // 追加

  "サプレッサー": "suppressor.png",
  "スモークグレネード": "smoke_grenade.png",
  "タクティカルサプレッサー": "suppressor.png",
  "フラッシュライト": "flashlight.png",

  "Bullpup Rifle MK2": "bullpup_rifle_mk2.png", // 追加
  "EMP round": "emp_round.png", // 追加
  "SMG用拡張マガジン": "smg_extended_mag.png", // 追加

  //========================
  // 化学作業台
  //========================
  "バックパックLv2": "backpack_lv2.png",
  "化学薬品クラフトテーブル": "chemical_crafting_table.png",
  "油": "oil.png",
  "メタルブレード": "metal_blade.png",
  "医療キット": "medkit.png",
  "鉄の歯車": "gear_iron.png",
  "バックパックLv1": "backpack_lv1.png",
  "スプレーリムーバー": "spray_remover.png",
  "スプレー": "spray.png",
  "車両引き換えゴールドチケット": "gold_ticket.png",
  "万能接合剤": "universal_adhesive.png",
  "ダッフルバッグ": "duffle_bag.png",
  "電子機器クラフトテーブル": "electronics_crafting_table.png",
  "ダイヤモンド": "diamond.png",
  "金属接合剤": "metal_adhesive.png",
  "包帯": "bandage.png",
  "SMGボディ": "smg_body.png",
  "ボイステープ": "voice_tape.png",
  "ピストルボディ": "pistol_body.png",
  "グラスファイバー": "glass_fiber.png",
  "武器クラフトテーブル": "weapon_crafting_table.png",
  "サボテンクリーム": "cactus_cream.png",
  "弾薬バッグ": "ammo_bag.png",
  "鉄のバネ": "spring_iron.png",
  "お着替えバッグ": "outfit_bag.png",

  //========================
  // 薬物製造台
  //========================
  "【麻薬】ブルーアウト": "drug_blueout.png",
  "【麻薬】レッドスペクター": "drug_redspecter.png",
  "【麻薬】ホワイトマッド": "drug_whitemud.png",

  //========================
  // 合鍵作成台
  //========================
  "宝石店の合鍵": "handcuff_key.png",
  "204号室の鍵": "handcuff_key.png",
  };


  function getImagePath(itemName) {
    const file = IMAGE_MAP[itemName];
    if (!file) return null;
    return `images/${file}`;
  }

  const ALT_RECIPES = {
    "貴金属": [
      { name: "金のインゴットで作る", recipe: { "金のインゴット": 2 }, yield: 1, costYen: 0 },
      { name: "メテオライトインゴットで作る", recipe: { "メテオライトインゴット": 1 }, yield: 1, costYen: 0 },
    ],
    "電子キット": [
      { name: "通常（1個）", recipe: { "貴金属": 1, "銅のインゴット": 1 }, yield: 1, costYen: 0 },
      { name: "量産（10個できる）", recipe: { "貴金属": 10, "銅のインゴット": 10 }, yield: 10, costYen: 0 },
    ],
    "油": [
      { name: "トウモロコシ袋詰め（5個できる）", recipe: { "トウモロコシの袋詰め": 1 }, yield: 5, costYen: 0 },
      { name: "ミルク箱詰め（2個できる）", recipe: { "ミルクの箱詰め": 1 }, yield: 2, costYen: 0 },
    ],
    "SMGボディ": [
      { name: "ピストルボディ3個で作る", recipe: { "ピストルボディ": 3 }, yield: 1, costYen: 100000 },
      { name: "カーボンファイバー50で作る", recipe: { "カーボンファイバー": 50 }, yield: 1, costYen: 100000 },
    ],
  };

  const META = {
  /////////// 違法物クラフト台
  // 爆弾系
  "犯罪用小型C4爆弾": { category: "違法物クラフト台", costYen: 1000, yield: 1 },
  "犯罪用小型テルミット爆弾": { category: "違法物クラフト台", costYen: 2000, yield: 1 },
  "犯罪用中型C4爆弾": { category: "違法物クラフト台", costYen: 2500, yield: 1 },
  "犯罪用中型テルミット爆弾": { category: "違法物クラフト台", costYen: 3000, yield: 1 },
  "犯罪用大型C4爆弾": { category: "違法物クラフト台", costYen: 5000, yield: 1 },
  "犯罪用大型テルミット爆弾": { category: "違法物クラフト台", costYen: 6500, yield: 1 }, // 追加

  // ドリル・切断系
  "小型ドリル": { category: "違法物クラフト台", costYen: 0, yield: 1 },
  "小型サーマルドリル": { category: "違法物クラフト台", costYen: 2000, yield: 1 },
  "犯罪用中型ドリル": { category: "違法物クラフト台", costYen: 1200, yield: 1 },
  "ダイヤモンドドリルビット": { category: "違法物クラフト台", costYen: 50000, yield: 1 },
  "小型グラインダー": { category: "違法物クラフト台", costYen: 500, yield: 1 },
  "犯罪用中型カッター": { category: "違法物クラフト台", costYen: 800, yield: 1 },
  "犯罪用大型カッター": { category: "違法物クラフト台", costYen: 2000, yield: 1 }, // 追加
  "犯罪用大型サーマルドリル": { category: "違法物クラフト台", costYen: 6000, yield: 1 }, // 追加
  "犯罪用大型ドリル": { category: "違法物クラフト台", costYen: 3000, yield: 1 }, // 追加

  // バッグ系
  "小型バッグ": { category: "違法物クラフト台", costYen: 100, yield: 1 },
  "犯罪用中型バッグ": { category: "違法物クラフト台", costYen: 500, yield: 1 },
  "犯罪用大型バッグ": { category: "違法物クラフト台", costYen: 1000, yield: 1 },

  // 電子機器系
  "電子キット": { category: "違法物クラフト台", costYen: 0, yield: 1 },
  "犯罪用USBメモリ 1.0": { category: "違法物クラフト台", costYen: 500, yield: 1 },
  "犯罪用USBメモリ 2.0": { category: "違法物クラフト台", costYen: 600, yield: 1 },
  "犯罪用USBメモリ 3.0": { category: "違法物クラフト台", costYen: 700, yield: 1 }, // 追加
  "犯罪用ノートパソコングレード1": { category: "違法物クラフト台", costYen: 1500, yield: 1 },
  "犯罪用ノートパソコングレード2": { category: "違法物クラフト台", costYen: 2000, yield: 1 },
  "犯罪用ノートパソコングレード3": { category: "違法物クラフト台", costYen: 4000, yield: 1 }, 

  // 侵入・解除ツール系
  "ロックピック": { category: "違法物クラフト台", costYen: 0, yield: 1 },
  "ビジネスバッグ用ロックピッカー": { category: "違法物クラフト台", costYen: 10000, yield: 1 },
  "犯罪用のバール": { category: "違法物クラフト台", costYen: 600, yield: 1 },
  "手錠の鍵": { category: "違法物クラフト台", costYen: 10000, yield: 1 },
  "中型ロープ": { category: "違法物クラフト台", costYen: 0, yield: 1 }, // 追加

  // 素材・戦利品系
  "貴金属": { category: "違法物クラフト台", costYen: 0, yield: 1 },

  /////////// ガンスミス
  // 銃本体
  "ピストル": { category: "ガンスミスワークベンチ", costYen: 100000, yield: 1 },
  "Micro SMG": { category: "ガンスミスワークベンチ", costYen: 200000, yield: 1 },
  "Bullpup Rifle MK2": { category: "ガンスミスワークベンチ", costYen: 400000, yield: 1 }, // 追加

  // 防具
  "頑丈な防弾チョッキ": { category: "ガンスミスワークベンチ", costYen: 50000, yield: 1 },

  // 投擲武器・特殊デバイス
  "フラッシュバン": { category: "ガンスミスワークベンチ", costYen: 0, yield: 2 },
  "スモークグレネード": { category: "ガンスミスワークベンチ", costYen: 0, yield: 2 },
  "グレネード": { category: "ガンスミスワークベンチ", costYen: 0, yield: 2 },
  "ポータブルEMPデバイス": { category: "ガンスミスワークベンチ", costYen: 0, yield: 2 },

  // 弾薬
  "9mm弾": { category: "ガンスミスワークベンチ", costYen: 0, yield: 100 },
  ".45 ACP弾": { category: "ガンスミスワークベンチ", costYen: 63000, yield: 100 },
  "5.56mm弾": { category: "ガンスミスワークベンチ", costYen: 63000, yield: 100 }, // 追加（※値段合ってるかだけ確認）

  // アタッチメント
  "フラッシュライト": { category: "ガンスミスワークベンチ", costYen: 5000, yield: 1 },
  "サプレッサー": { category: "ガンスミスワークベンチ", costYen: 5000, yield: 1 },
  "タクティカルサプレッサー": { category: "ガンスミスワークベンチ", costYen: 5000, yield: 1 },
  "SMG用拡張マガジン": { category: "ガンスミスワークベンチ", costYen: 5000, yield: 1 }, // 追加
  "EMP round": { category: "ガンスミスワークベンチ", costYen: 0, yield: 1 }, // 追加

  /////////// 化学作業台
  // 作業台（テーブル類）
  "化学薬品クラフトテーブル": { category: "化学作業台", costYen: 50000000, yield: 1 },
  "電子機器クラフトテーブル": { category: "化学作業台", costYen: 50000000, yield: 1 },
  "武器クラフトテーブル": { category: "化学作業台", costYen: 50000000, yield: 1 },

  // バッグ類
  "バックパックLv1": { category: "化学作業台", costYen: 0, yield: 1 },
  "バックパックLv2": { category: "化学作業台", costYen: 30000, yield: 1 },
  "ダッフルバッグ": { category: "化学作業台", costYen: 100000, yield: 1 },
  "弾薬バッグ": { category: "化学作業台", costYen: 10000, yield: 1 },
  "お着替えバッグ": { category: "化学作業台", costYen: 0, yield: 1 },

  // 医療・回復系
  "医療キット": { category: "化学作業台", costYen: 10000, yield: 1 },
  "包帯": { category: "化学作業台", costYen: 0, yield: 1 },
  "サボテンクリーム": { category: "化学作業台", costYen: 0, yield: 1 },

  // 武器パーツ
  "ピストルボディ": { category: "化学作業台", costYen: 100000, yield: 1 },
  "SMGボディ": { category: "化学作業台", costYen: 0, yield: 1 },

  // 接合剤・ケミカル類
  "金属接合剤": { category: "化学作業台", costYen: 5000, yield: 1 },
  "万能接合剤": { category: "化学作業台", costYen: 10000, yield: 1 },

  // 素材・部品
  "油": { category: "化学作業台", costYen: 0, yield: 1 },
  "グラスファイバー": { category: "化学作業台", costYen: 0, yield: 1 },
  "メタルブレード": { category: "化学作業台", costYen: 0, yield: 1 },
  "鉄の歯車": { category: "化学作業台", costYen: 0, yield: 1 },
  "鉄のバネ": { category: "化学作業台", costYen: 0, yield: 1 },

  // その他
  "スプレー": { category: "化学作業台", costYen: 0, yield: 1 },
  "スプレーリムーバー": { category: "化学作業台", costYen: 0, yield: 1 },
  "ボイステープ": { category: "化学作業台", costYen: 0, yield: 1 },
  "ダイヤモンド": { category: "化学作業台", costYen: 0, yield: 5 },
  "車両引き換えゴールドチケット": { category: "化学作業台", costYen: 0, yield: 1 },
  "銃器（ショーケースを壊せるもの）": { category: "道具", super: false },

  // 薬物製造台
  "【麻薬】ブルーアウト": { category: "薬物製造台", costYen: 0, yield: 1 },
  "【麻薬】レッドスペクター": { category: "薬物製造台", costYen: 0, yield: 1 },
  "【麻薬】ホワイトマッド": { category: "薬物製造台", costYen: 0, yield: 1 },

  // 合鍵作成台
  "宝石店の合鍵": { category: "合鍵作成台", costYen: 0, yield: 1 },
  "204号室の鍵": { category: "合鍵作成台", costYen: 0, yield: 1 },
  };


  // スーパー購入価格（1個あたり）
  const SHOP_PRICE = {
    "アルミ粉": 10000,
    "エメラルド": 10000,
    "サファイア": 10000,
    "ダイヤモンド": 10000,

    "メテオライトインゴット": 2000,
    "金のインゴット": 10000,
    "銀のインゴット": 10000,

    "鉄のインゴット": 2000,
    "銅のインゴット": 10000,
    "鋼鉄のインゴット": 10000,

    "小型グラインダー": 200000,
    "小型サーマルドリル": 200000,
    "小型ドリル": 200000,

    "小型バッグ": 200000,
    "小型ロープ": 200000,
  };


  /* =======================
    犯罪プリセット（ここを編集すれば増やせます）
    - key: 犯罪名
    - value: 必要な「道具（=このページのアイテム名）」: 個数
    ※ 人数分が必要なもの（バッグ等）は、犯罪ページの「回数」を人数にして調整してください。
  ======================= */
  const CRIMES = {
    "小型 - 家強盗（空き巣）": {
      "__NOTE__": "🛒 ポータブル溶接機：受注NPCから購入",
      "__NOTE2__": "📍 受注場所：8012",
      "__NOTE3__": "📍 換金場所：8012"
    },

    "小型 - コンビニ強盗": {
      "__NOTE__": "銃器：店員NPCをダウンさせられる、レジを解放できるもの（コンビニ購入）"
    },

    "小型 - ATM強盗": {
      methods: {
        "ATM引き抜き強盗": {
          "__NOTE__": "共通：人質を用意するなら銃器が必要、逃走車両もあると良い",
          "小型ロープ": 1,
          "車両（馬力の高い車。SUV推奨）": 1
        },
        "ドリル強盗": {
          "__NOTE__": "共通：人質を用意するなら銃器が必要、逃走車両もあると良い",
          "__NOTE2__": "小型ドリルはミニゲーム成功/失敗で消費",
          "小型ドリル": 1
        },
        "爆弾強盗": {
          "__NOTE__": "共通：人質を用意するなら銃器が必要、逃走車両もあると良い",
          "犯罪用小型C4爆弾": 1
        },
        "ハッキング強盗": {
          "__NOTE__": "共通：人質を用意するなら銃器が必要、逃走車両もあると良い",
          "__NOTE2__": "USBはミニゲーム成功/失敗で消費",
          "犯罪用USBメモリ 1.0": 1
        }
      }
    },

    "小型 - フリーサ銀行強盗": {
      "犯罪用USBメモリ 1.0": 1,
      "犯罪用小型C4爆弾": 2,
      "ダイヤモンド": 80
    },

    "小型 - 両替所強盗": {
      methods: {
        "Loud Approach": {
          "__NOTE__": "🔑 両替所の鍵 ×1（ミッション中に入手）",
          "__NOTE2__": "🔫 銃器：人質管理のために必要",

          "犯罪用USBメモリ 1.0": 1,
          "小型バッグ": 1,
          "小型グラインダー": 3
        },

        "Silent Approach": {
          "__NOTE__": "🔑 両替所の鍵 ×1（ミッション中に入手）",
          "__NOTE2__": "💻 復号化されたデバイス ×1（ミッション中に入手）",
          "__NOTE3__": "🔫 銃器：人質管理のために必要",

          "犯罪用USBメモリ 1.0": 1,
          "小型バッグ": 1,
          "小型グラインダー": 2
        }
      }
    },

    "小型 - 輸送車両強盗": {
      "小型バッグ": 1,
      "小型ドリル": 2,
      "犯罪用小型C4爆弾": 1
    },

  "中型 - パレト銀行強盗": {

    "__NOTE__": "📍 場所：1055",
    "__NOTE2__": "🏦 中規模強盗ではあるものの、人質を取ることが可能な犯罪です",
    "__NOTE3__": "⚠ USBメモリはミニゲーム成功・失敗に関係なく消費されます",

    "犯罪用ノートパソコン グレード2": 1,
    "犯罪用中型ドリル": 3,
    "犯罪用USBメモリ 2.0": 3

  },

    "中型 - クルーザー強盗": {

      "__NOTE__": "🚢 船上で「犯罪用USBメモリ 2.0」を使用すると犯罪開始",
      "__NOTE2__": "💀 船上に出現するNPCを殲滅しながら報酬を回収",
      "__NOTE3__": "🛠 USBメモリは金庫のミニゲームを失敗しても消費",

      "犯罪用USBメモリ 2.0": 2,
      "犯罪用中型ドリル": 4

    },

    "中型 - 宝石店強盗": {

      "__NOTE__": "📍 場所：7251",
      "__NOTE2__": "🔫 銃器：ショーケースを壊せるもの",

      "宝石店の合鍵": 1,
      "犯罪用のバール": 1,
      "犯罪用中型カッター": 4,
      "銃器（ショーケースを壊せるもの）": 1

    },
    
    "中型 - 金庫強盗": {

    "__NOTE__": "📍 場所：7115地下",
    "__NOTE2__": "👥 受注条件：3人で現地へ向かうこと",
    "__NOTE3__": "💾 犯罪用USBメモリ 2.0 は失敗でも消費",
    "__NOTE4__": "🪢 中型ロープは金庫を牽引する運転手が所持",

    "犯罪用USBメモリ 2.0": 1,
    "中型ロープ": 2,
    "犯罪用中型バック（1人あたり）": 1

    },

    "大型 - ボブキャット強盗": {

      methods: {

        "Loud Approach": {

          "__NOTE__": "📍 場所：9274",
          "__NOTE2__": "💰 犯罪用中型バッグ ×1（回収者の人数分）",

          "犯罪用ノートパソコングレード2": 5,
          "犯罪用のバール": 1,
          "犯罪用中型C4爆弾": 3,
          "犯罪用USBメモリ 2.0": 3,
          "犯罪用中型バッグ": 1
        },

        "Silent Approach": {

          "__NOTE__": "📍 場所：9274",
          "__NOTE2__": "💰 犯罪用中型バッグ ×1（回収者の人数分）",

          "犯罪用ノートパソコングレード2": 5,
          "犯罪用のバール": 1,
          "犯罪用中型C4爆弾": 1,
          "犯罪用USBメモリ 2.0": 5,
          "スモークグレネード": 1,
          "犯罪用中型バッグ": 1
        }

      }

    },

    "大型 - ユニオン銀行": {

      "__NOTE__": "📍 受注場所：7112番 204号室",
      "__NOTE2__": "👤 金持ち役の人は必ず受注者に同行して受注場所に向かう",
      "__NOTE3__": "💰 犯罪用大型バッグ ×回収人数分（回収者それぞれが1つ所持）",
      "__NOTE4__": "⚠️ 注意：受注直前に全員必ずリログしてください",

      "204号室の鍵": 1,
      "犯罪用大型バッグ": 1,
      "犯罪用大型C4爆弾": 8

    },

    "大型 - 飛行場強盗": {

    "__NOTE__": "📍 受注場所：7112番地 2階 213号室",
    "__NOTE2__": "⏱ 受注後10分以内に空港滑走路付近へ接近すること",
    "__NOTE3__": "📢 滑走路付近に近づき通知が表示された時点でミッション開始",
    "__NOTE4__": "⚠ 制限時間内にエリア進入が確認されない場合、自動リセット",

    "213号室の鍵": 1,
    "犯罪用大型C4爆弾": 1

    },

    "大型 - 貨物列車強盗": {

    "__NOTE__": "📍 受注場所：7112番地 209号室",
    "__NOTE2__": "📦 コンテナ1つにつきカッター1個（最大8個）",
    "__NOTE3__": "👤 各所ギミックは必ず受注者が実行（他者が行うとバグ発生）",
    "__NOTE4__": "⚠ 同期バグ防止のため各項目の注意事項を必ず確認",
    "__NOTE5__": "⏱ 受注後30分以上経過すると進行不可になる可能性あり",
    "__NOTE6__": "🚫 コンテナ二重・透過バグ時は報酬箱を絶対に開けない",
    "__NOTE7__": "📦 コンテナが開いた時点で取得成功扱い（未取得時は補填部屋へ）",
    "__NOTE8__": "🔄 受注直前に全員必ずリログすること",

    "209号室の鍵": 1,
    "犯罪用大型カッター": 8

},


};

function getCrimeReq(crimeName, methodName){
  const preset = CRIMES[crimeName] || {};
  if (preset.methods){
    const m = methodName || Object.keys(preset.methods)[0];
    return preset.methods[m] || {};
  }
  return preset;
}

function getCrimeDot(crimeName){
  if (crimeName.includes("大型")) return '<span class="crime-dot large">●</span>';
  if (crimeName.includes("中型")) return '<span class="crime-dot mid">●</span>';
  if (crimeName.includes("小型") || crimeName.includes("小規模")) return '<span class="crime-dot small">●</span>';
  return '';
}

function getCrimeDisplayName(name){
  return name
    .replace(/^中型\s*-\s*/,"")
    .replace(/^大型\s*-\s*/,"")
    .replace(/^小型\s*-\s*/,"")
    .replace(/^小規模犯罪\s*-\s*/,"");
}



/* =======================
   状態
======================= */
let currentCategory = "違法物クラフト台";
const counts = {};          // itemName -> craftTimes
const favorites = new Set();
const altChoice = {};

const selectedCrimes = []; // [{name, times}]
let crimeRequiredSet = new Set();
let currentPage = "craft";
       // altChoice["貴金属"]=0 など

/* =======================
   入力保持（localStorage）
======================= */
const LS_KEY = "craft_crime_state_v1";

function loadState(){
  try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
  catch(e){ return {}; }
}

function saveStateDebounced(){
  clearTimeout(saveStateDebounced._t);
  saveStateDebounced._t = setTimeout(() => {
    const payload = {
      // craft
      currentCategory,
      counts,
      favorites: Array.from(favorites),
      altChoice,
      // UI
      craftUI: {
        search: searchBox?.value || "",
        showOnlyFav: !!showOnlyFav?.checked,
        showOnlyEntered: !!showOnlyEntered?.checked,
        pinEntered: !!pinEntered?.checked,
      },

      // crime
      crimeUI: {
        crimeSelect: crimeSelect?.value || "",
        crimeMethod: crimeMethod?.classList.contains("hidden") ? "" : (crimeMethod?.value || ""),
        crimeTimes: Number(crimeTimes?.value || 1) || 1,
        includeMaterials: !!crimeIncludeMaterials?.checked,
        singleMode: !!crimeSingleMode?.checked,
        selectedCrimes, // 複数追加してるならこれを保存するのが一番自然
      },

      currentPage
    };

    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }, 200);
}

function restoreState(){
  const st = loadState();

  // craft状態
  if (st.currentCategory) currentCategory = st.currentCategory;

  if (st.counts && typeof st.counts === "object") {
    for (const [k,v] of Object.entries(st.counts)) counts[k] = Number(v) || 0;
  }

  favorites.clear();
  if (Array.isArray(st.favorites)) st.favorites.forEach(x => favorites.add(x));

  if (st.altChoice && typeof st.altChoice === "object") {
    for (const [k,v] of Object.entries(st.altChoice)) altChoice[k] = v;
  }

  // craft UI
  if (st.craftUI) {
    if (searchBox) searchBox.value = st.craftUI.search || "";
    if (showOnlyFav) showOnlyFav.checked = !!st.craftUI.showOnlyFav;
    if (showOnlyEntered) showOnlyEntered.checked = !!st.craftUI.showOnlyEntered;
    if (pinEntered) pinEntered.checked = !!st.craftUI.pinEntered;
  }

  // crime UI
  if (st.crimeUI) {
    if (crimeIncludeMaterials) crimeIncludeMaterials.checked = !!st.crimeUI.includeMaterials;
    if (crimeSingleMode) crimeSingleMode.checked = !!st.crimeUI.singleMode;
    if (crimeTimes) crimeTimes.value = String(st.crimeUI.crimeTimes || 1);

    // 選択中プリセット
    if (crimeSelect && st.crimeUI.crimeSelect) crimeSelect.value = st.crimeUI.crimeSelect;

    // methodsの有無を反映
    updateCrimeDotPreview();
    updateMethodSelect();

    // 方法
    if (crimeMethod && st.crimeUI.crimeMethod && !crimeMethod.classList.contains("hidden")) {
      crimeMethod.value = st.crimeUI.crimeMethod;
    }

    // 複数追加の状態
    if (Array.isArray(st.crimeUI.selectedCrimes)) {
      selectedCrimes.length = 0;
      st.crimeUI.selectedCrimes.forEach(x => {
        if (!x?.name) return;
        selectedCrimes.push({
          name: x.name,
          method: x.method ?? null,
          times: Math.max(1, Number(x.times || 1) || 1),
        });
      });
    }
  }

  // 最後に開いてたページ
  if (st.currentPage) currentPage = st.currentPage;
}


/* =======================
   DOM
   ※ null対策：必ず存在チェックしてから使う
======================= */
const $ = (id) => document.getElementById(id);

// ★ crime系はまとめる
const crimeSelect = $("crimeSelect");
const crimeMethod = $("crimeMethod");
const crimeTimes  = $("crimeTimes");
const crimeDotPreview = $("crimeDotPreview");

const categorySeg = $("categorySeg");
const itemsEl = $("items");
const matsEl  = $("materials");
const altEl   = $("altBreakdowns");

const searchBox = $("searchBox");
const showOnlyFav = $("showOnlyFav");
const showOnlyEntered = $("showOnlyEntered");
const pinEntered = $("pinEntered");
const resetBtn = $("resetBtn");

const tabCraft = $("tabCraft");
const tabCrime = $("tabCrime");
const craftPage = $("craftPage");
const crimePage = $("crimePage");

function updateMethodSelect(){
  if(!crimeMethod || !crimeSelect) return;

  const crimeName = crimeSelect.value;
  const preset = CRIMES[crimeName] || {};

  // methodsが無い犯罪は「方法」非表示
  if(!preset.methods){
    crimeMethod.classList.add("hidden");
    crimeMethod.innerHTML = "";
    return;
  }

  // methodsがある犯罪は表示して中身を詰める
  crimeMethod.classList.remove("hidden");

  const methods = Object.keys(preset.methods);
  crimeMethod.innerHTML = methods.map(m => `<option value="${m}">${m}</option>`).join("");

  // 未選択なら先頭を選ぶ
  if(!crimeMethod.value) crimeMethod.value = methods[0];
}

function updateCrimeDotPreview(){
  const name = crimeSelect.value;

  if(!name) return;

  if(name.includes("大型")){
    crimeDotPreview.className = "crime-dot large";
  }
  else if(name.includes("中型")){
    crimeDotPreview.className = "crime-dot mid";
  }
  else if(name.includes("小型") || name.includes("小規模")){
    crimeDotPreview.className = "crime-dot small";
  }
}

crimeSelect.addEventListener("change", () => {
  updateCrimeDotPreview();
  updateMethodSelect();

  // 単体モードなら、その場で反映（後でmethod対応するための土台）
  if (crimeSingleMode?.checked){
    selectedCrimes.length = 0;
    selectedCrimes.push({
      name: crimeSelect.value,
      method: crimeMethod?.classList.contains("hidden") ? null : crimeMethod.value,
      times: Math.max(1, Number(crimeTimes?.value || 1) || 1)
    });
  }

  renderCrimePlan();
  renderCrimeItems();
});


// 初期表示（重要）
setTimeout(updateCrimeDotPreview, 0);
setTimeout(updateMethodSelect, 0);


const crimeIncludeMaterials = $("crimeIncludeMaterials");
const crimeSingleMode = $("crimeSingleMode");
const addCrimeBtn = $("addCrimeBtn");
const clearCrimeBtn = $("clearCrimeBtn");
const crimePlanEl = $("crimePlan");
const crimeItemsEl = $("crimeItems");



const totalYenEl = $("totalYen");
const yenBreakdownEl = $("yenBreakdown");
const resultNote = $("resultNote");

const shopMatsTotalEl = $("shopMatsTotal");
const shopMatsBreakdownEl = $("shopMatsBreakdown");
const shopItemsTotalEl = $("shopItemsTotal");
const shopItemsBreakdownEl = $("shopItemsBreakdown");

const altDetails = $("altDetails");

function applyCrimeToCraft({ mode = "replace" } = {}){
  // 犯罪で必要な「道具」合計（回数反映済み）
  const crimeTotals = computeCrimeTotals(); // { itemName: qty }

  // counts初期化 or 追加
  if (mode === "replace"){
    for (const k of Object.keys(counts)) counts[k] = 0;
  }

  // crimeTotalsのうち、クラフト可能（METAにいる）なものだけ反映
  for (const [name, qty] of Object.entries(crimeTotals)){
    const q = Number(qty || 0);
    if (q <= 0) continue;

    // ここが重要：METAに存在する=クラフト側に表示できる
    if (!META[name]) continue;

    counts[name] = (mode === "add")
      ? (Number(counts[name] || 0) + q)
      : q;
  }

  // クラフト側に移動して再描画
  setPage("craft");
  renderCategorySeg();
  renderItems();
  renderResults();

  // localStorage保存（入れてるなら）
  if (typeof saveStateDebounced === "function") saveStateDebounced();
}

/* =======================
   ユーティリティ
======================= */
function fmtYen(n){ return (n||0).toLocaleString("ja-JP"); }

function getYield(itemName){
  const y = META[itemName]?.yield;
  return Number.isFinite(y) && y > 0 ? y : 1;
}
function getCost(itemName){
  const c = META[itemName]?.costYen;
  return Number.isFinite(c) && c >= 0 ? c : 0;
}
function itemsByCategory(cat){
  return Object.keys(META).filter(k => META[k]?.category === cat);
}
function passesFilters(name){
  const q = (searchBox?.value || "").trim().toLowerCase();
  if (q && !name.toLowerCase().includes(q)) return false;
  if (showOnlyFav?.checked && !favorites.has(name)) return false;
  if (showOnlyEntered?.checked && (counts[name]||0) <= 0) return false;
  return true;
}

/* =======================
   計算：素材合計 + クラフト料金合計（基本）
   - ALT対象は「必要個数」として totals に入れるだけ
======================= */
function computeBaseTotalsAndCost(){
  const totals = {};
  let cost = 0;
  const costBreakdown = [];

  for (const [itemName, craftTimes] of Object.entries(counts)) {
    const t = craftTimes || 0;
    if (t <= 0) continue;

    const itemCost = getCost(itemName) * t;
    cost += itemCost;
    costBreakdown.push({ name:itemName, yen:itemCost });

    // ALTアイテムは「欲しい個数」として扱う（材料展開はALT側）
    if (ALT_RECIPES[itemName]) {
      totals[itemName] = (totals[itemName] || 0) + t;
      continue;
    }

    const recipe = RECIPES[itemName];
    if (!recipe) continue;

    for (const [mat, per] of Object.entries(recipe)) {
      totals[mat] = (totals[mat] || 0) + per * t;
    }
  }

  return { totals, cost, costBreakdown };
}

/* =======================
   代替レシピの展開（手動選択）
   - totals[altItem] を必要数として、選択レシピの材料を加算
======================= */
function buildAltBreakdowns(totals){
  const breakdowns = [];
  let chosenCostAdd = 0;
  const chosenCostBreakdown = [];
  const chosenMatsAdd = {};

  for (const [altItem, options] of Object.entries(ALT_RECIPES)) {
    const need = totals[altItem] || 0;
    if (need <= 0) continue;

    if (altChoice[altItem] == null) altChoice[altItem] = 0;

    const optionResults = options.map((opt, idx) => {
      const y = opt.yield || 1;
      const craftTimes = Math.ceil(need / y);

      const mats = {};
      for (const [mat, per] of Object.entries(opt.recipe)) {
        mats[mat] = per * craftTimes;
      }
      const costYen = (opt.costYen || 0) * craftTimes;

      return { idx, name: opt.name, need, yield:y, craftTimes, mats, costYen };
    });

    let chosenIndex = altChoice[altItem];
    if (!Number.isFinite(chosenIndex) || chosenIndex < 0 || chosenIndex >= optionResults.length) {
      chosenIndex = 0;
      altChoice[altItem] = 0;
    }
    const chosen = optionResults[chosenIndex];

    chosenCostAdd += chosen.costYen;
    chosenCostBreakdown.push({ name: `${altItem}（採用：${chosen.name}）`, yen: chosen.costYen });

    for (const [mat, v] of Object.entries(chosen.mats)) {
      chosenMatsAdd[mat] = (chosenMatsAdd[mat] || 0) + v;
    }

    breakdowns.push({ item: altItem, need, options: optionResults, chosenIndex });
  }

  return { breakdowns, chosenCostAdd, chosenCostBreakdown, chosenMatsAdd };
}

/* =======================
   スーパー購入計算
======================= */
// 必要素材 totals から「買える素材」だけ合計
function calcShopCostFromTotals(totals){
  let sum = 0;
  const lines = [];
  const missing = [];

  for (const [name, qty] of Object.entries(totals)) {
    const q = qty || 0;
    if (q <= 0) continue;
    if (SHOP_PRICE[name] != null) {
      const yen = SHOP_PRICE[name] * q;
      sum += yen;
      lines.push({ name, yen });
    } else {
      missing.push(name);
    }
  }

  lines.sort((a,b)=> b.yen - a.yen);
  return { sum, lines, missing };
}

// 入力した「完成品そのもの」をスーパーで買えるか合計
function calcShopCostFromEnteredItems(){
  let sum = 0;
  const lines = [];
  const missing = [];

  for (const [itemName, craftTimes] of Object.entries(counts)) {
    const t = craftTimes || 0;
    if (t <= 0) continue;

    // 完成品購入は「出来上がり数」ベースにしたいなら produced を使う
    // 今回は「入力回数＝欲しい個数」運用っぽいので t をそのまま個数扱い
    const qty = t;

    if (SHOP_PRICE[itemName] != null) {
      const yen = SHOP_PRICE[itemName] * qty;
      sum += yen;
      lines.push({ name: itemName, yen });
    } else {
      missing.push(itemName);
    }
  }

  lines.sort((a,b)=> b.yen - a.yen);
  return { sum, lines, missing };
}

/* =======================
   代替選択ハンドラ（グローバル）
======================= */
window.handleAltChoiceChange = function(altItem, idx){
  altChoice[altItem] = idx;
  renderResults();
};

/* =======================
   レンダリング
======================= */
function renderCategorySeg(){
  if (!categorySeg) return;
  categorySeg.innerHTML = "";
  for (const cat of CATEGORIES) {
    const b = document.createElement("button");
    b.textContent = cat;
    b.className = (cat === currentCategory) ? "active" : "";
    b.addEventListener("click", () => {
      currentCategory = cat;
      renderCategorySeg();
      renderItems();
    });
    categorySeg.appendChild(b);
  }
}

function renderItems(){
  if (!itemsEl) return;
  itemsEl.innerHTML = "";

  let list = itemsByCategory(currentCategory).filter(passesFilters);

  list.sort((a,b)=>{
    const aEntered = (counts[a]||0) > 0;
    const bEntered = (counts[b]||0) > 0;
    if (pinEntered?.checked && aEntered !== bEntered) return aEntered ? -1 : 1;

    const aFav = favorites.has(a);
    const bFav = favorites.has(b);
    if (aFav !== bFav) return aFav ? -1 : 1;

    return a.localeCompare(b, "ja");
  });

  if (list.length === 0) {
    itemsEl.innerHTML = `<div class="muted">該当するアイテムがありません（検索条件/トグルを見直してね）</div>`;
    renderResults();
    return;
  }

  for (const itemName of list) {
    const row = document.createElement("div");
    row.className = "row";

    const craftTimes = counts[itemName] ?? 0;
    if (craftTimes > 0) row.classList.add("entered");

    const left = document.createElement("div");
    left.className = "name";

    const star = document.createElement("button");
    star.className = "star" + (favorites.has(itemName) ? " on" : "");
    star.innerHTML = favorites.has(itemName) ? "★" : "☆";
    star.title = "お気に入り";
    star.addEventListener("click", () => {
      if (favorites.has(itemName)) favorites.delete(itemName);
      else favorites.add(itemName);
      renderItems();
    });

    const y = getYield(itemName);
    const produced = craftTimes * y;
    const cost = getCost(itemName);

    const info = document.createElement("div");
    info.className = "titleWrap";
    info.innerHTML = `
      <div class="title">${itemName}</div>
      <div class="meta">
        <span class="badge">出来上がり：${produced}（${y}個/回）</span>
        <span class="badge">料金：${fmtYen(cost)}円/回</span>
      </div>
    `;

    left.appendChild(star);

    const imgPath = getImagePath(itemName);
    if (imgPath) {
      const img = document.createElement("img");
      img.className = "icon";
      img.src = imgPath;
      img.alt = itemName;
      img.loading = "lazy";
      img.decoding = "async";
      img.addEventListener("error", () => img.remove());
      left.appendChild(img);
    }

    left.appendChild(info);

    const input = document.createElement("input");
    input.type = "number";
    input.min = "0";
    input.step = "1";
    input.value = craftTimes;

    input.addEventListener("input", () => {
      const v = Math.floor(Number(input.value || 0));
      counts[itemName] = Math.max(0, v);
      renderItems();
    });

    row.appendChild(left);
    row.appendChild(input);
    itemsEl.appendChild(row);
  }

  renderResults();
}


/* =======================
   犯罪ページ用
======================= */
function getCrimeNames(){ return Object.keys(CRIMES); }

function computeCrimeTotals(){
  const totals = {};
  for (const c of selectedCrimes) {
    const times = Math.max(1, Number(c.times || 1) || 1);

    // ★ ここがポイント：method対応
    const req = getCrimeReq(c.name, c.method);

    for (const [item, qty] of Object.entries(req)) {
      if (item.startsWith("__NOTE")) continue;
      totals[item] = (totals[item] || 0) + (Number(qty || 0) * times);
    }
  }
  return totals;
}

function computeCrimeRequiredSet(){
  const includeMaterials = !!crimeIncludeMaterials?.checked;
  const totals = computeCrimeTotals();
  const reqSet = new Set(Object.keys(totals));

  if (!includeMaterials) return reqSet;

  const stack = [...reqSet];
  const seen = new Set(stack);

  while (stack.length){
    const item = stack.pop();
    const recipe = RECIPES[item];
    if (!recipe) continue;
    for (const ing of Object.keys(recipe)){
      if (!seen.has(ing)){
        seen.add(ing);
        reqSet.add(ing);
        stack.push(ing);
      }
    }
  }
  return reqSet;
}

function refreshCrimeFilters(){
  crimeRequiredSet = computeCrimeRequiredSet();
}

function renderCrimeSelect(){
  if (!crimeSelect) return;
  const names = getCrimeNames();
  crimeSelect.innerHTML = names
    .map(n => `<option value="${n}">${getCrimeDisplayName(n)}</option>`)
    .join("");
}


function renderCrimePlan(){
  if (!crimePlanEl) return;

  if (!selectedCrimes.length){
    crimePlanEl.innerHTML = "（まだ追加がありません）";
    return;
  }

  const totals = computeCrimeTotals();

  // NOTE取得（複数NOTE対応）
  const notes = selectedCrimes.flatMap(c => {
    const crimeBase = CRIMES[c.name] || {};

      // method選択がある場合はそっちを優先
      let crime = crimeBase;

      if (crimeBase.methods && c.method && crimeBase.methods[c.method]) {
        crime = crimeBase.methods[c.method];
      }

        // NOTE抽出
        return Object.entries(crime)
          .filter(([k,v]) => k.startsWith("__NOTE") && v)
          .sort(([a],[b]) => a.localeCompare(b, "ja"))
          .map(([k,v]) => String(v));

  });
  
  const lines = Object.entries(totals)
    .filter(([,v]) => (v||0) > 0)
    .sort((a,b)=> (b[1]||0) - (a[1]||0))
    .map(([k,v]) => `<div class="kv"><span>${k}</span><b>${v}</b></div>`)
    .join("");

  const chips = selectedCrimes.map((c, i) => {
    const t = Math.max(1, Number(c.times||1)||1);
    return `
      <span class="badge" style="margin:4px 6px 0 0; display:inline-flex; align-items:center; gap:6px;">
        ${getCrimeDot(c.name)}${getCrimeDisplayName(c.name)} ×${t}
        <button class="star" style="width:26px; height:26px; border-radius:10px;"
                title="削除" onclick="removeCrime(${i})">×</button>
      </span>
    `;
  }).join("");

  crimePlanEl.innerHTML = `
    <div style="margin-bottom:8px;">${chips}</div>
    ${lines ? `
      <div class="muted" style="margin:6px 0 10px;">合計（必要道具）</div>
    ${lines}
      ` : ""}
    `;
    // NOTE表示
    if(notes.length){
      crimePlanEl.innerHTML += `
        <div class="box note-box" style="margin-top:10px;">
          <div class="secTitle">📋 必要条件</div>
          <div class="note-text">
            ${notes.join("<br>")}
          </div>
        </div>
      `;
    }


}

window.removeCrime = function(i){
  selectedCrimes.splice(i, 1);
  refreshCrimeFilters();
  renderCrimePlan();
  renderCrimeItems();
};

function renderCrimeItems(){
  if (!crimeItemsEl) return;
  refreshCrimeFilters();

  const totals = computeCrimeTotals();
  const items = Object.keys(META).filter(name => crimeRequiredSet.has(name));

  items.sort((a,b)=>{
    const ca = META[a]?.category || "";
    const cb = META[b]?.category || "";
    if (ca !== cb) return ca.localeCompare(cb, "ja");
    return a.localeCompare(b, "ja");
  });

  crimeItemsEl.innerHTML = items.map(name => {
    const cat = META[name]?.category || "";
    const qty = (name in totals) ? totals[name] : null;
    const tag = (qty == null && crimeIncludeMaterials?.checked) ? "（素材）" : "";
    return `
      <div class="item">
        <div class="meta">
          <div class="name">${name}</div>
          <div class="muted">${cat}${tag}</div>
        </div>
        <div class="qty">${qty == null ? "-" : qty}</div>
      </div>
    `;
  }).join("") || '<div class="muted">（この犯罪に必要なアイテムが見つかりません）</div>';
}

function clearCrimePlan(){
  selectedCrimes.length = 0;
  refreshCrimeFilters();
  renderCrimePlan();
  renderCrimeItems();
}

function setPage(mode){
  const isCrime = (mode === "crime");
  currentPage = isCrime ? "crime" : "craft";

  if (craftPage) craftPage.classList.toggle("hidden", isCrime);
  if (crimePage) crimePage.classList.toggle("hidden", !isCrime);

  if (tabCraft) tabCraft.classList.toggle("active", !isCrime);
  if (tabCrime) tabCrime.classList.toggle("active", isCrime);

  if (isCrime){
    updateCrimeDotPreview();
    updateMethodSelect();

  // ★復元済み（selectedCrimesがある）なら上書きしない
  if (!selectedCrimes.length && crimeSingleMode?.checked && crimeSelect?.value){
    selectedCrimes.push({
      name: crimeSelect.value,
      method: crimeMethod?.classList.contains("hidden") ? null : (crimeMethod?.value || null),
      times: Math.max(1, Number(crimeTimes?.value || 1) || 1),
    });
  }

  renderCrimePlan();
  renderCrimeItems();

  } else {
    renderItems();
  }

  saveStateDebounced();

}

function renderResults(){
  const { totals: baseTotals, cost: baseCost, costBreakdown: baseBreak } = computeBaseTotalsAndCost();
  const { breakdowns, chosenCostAdd, chosenCostBreakdown, chosenMatsAdd } = buildAltBreakdowns(baseTotals);

  // 最終素材（base + 代替採用材料）
  const totals = { ...baseTotals };
  for (const [k,v] of Object.entries(chosenMatsAdd)) {
    totals[k] = (totals[k] || 0) + v;
  }
  // ALTアイテム自身は素材一覧から消す（代替欄で見える）
  for (const altItem of Object.keys(ALT_RECIPES)) {
    if (totals[altItem]) delete totals[altItem];
  }

  // 必要素材（合計）
  const entries = Object.entries(totals).sort((a,b)=> b[1]-a[1]);
  if (matsEl) {
    matsEl.innerHTML = entries.length
      ? entries.map(([k,v]) => `<div class="kv"><span>${k}</span><b>${v}</b></div>`).join("")
      : `<div class="muted">まだ入力がありません</div>`;
  }

  // クラフト料金合計
  const totalCost = baseCost + chosenCostAdd;
  if (totalYenEl) totalYenEl.textContent = `${fmtYen(totalCost)}円`;

  // クラフト料金内訳
  const mergedBreak = [...baseBreak, ...chosenCostBreakdown].sort((a,b)=> b.yen - a.yen);
  if (yenBreakdownEl) {
    yenBreakdownEl.innerHTML = mergedBreak.length
      ? mergedBreak.map(x => `・${x.name}：<b>${fmtYen(x.yen)}円</b>`).join("<br>")
      : "・（まだ入力がありません）";
  }

  // スーパー（材料）
  const matsShop = calcShopCostFromTotals(totals);
  if (shopMatsTotalEl) shopMatsTotalEl.textContent = `${fmtYen(matsShop.sum)}円`;
  if (shopMatsBreakdownEl) {
    const s1 = matsShop.lines.length
      ? matsShop.lines.map(x => `・${x.name}：<b>${fmtYen(x.yen)}円</b>`).join("<br>")
      : "・（スーパー購入対象なし）";
    shopMatsBreakdownEl.innerHTML = s1;
  }

  // スーパー（完成品）
  const itemsShop = calcShopCostFromEnteredItems();
  if (shopItemsTotalEl) shopItemsTotalEl.textContent = `${fmtYen(itemsShop.sum)}円`;
  if (shopItemsBreakdownEl) {
    const s2 = itemsShop.lines.length
      ? itemsShop.lines.map(x => `・${x.name}：<b>${fmtYen(x.yen)}円</b>`).join("<br>")
      : "・（スーパー購入対象なし）";
    shopItemsBreakdownEl.innerHTML = s2;
  }

  // 代替レシピ表示（手動選択）
  if (altDetails && altEl) {
    if (breakdowns.length) {
      altDetails.open = true;
      altEl.innerHTML = breakdowns.map(b => {
        const opts = b.options.map(opt => {
          const mats = Object.entries(opt.mats)
            .map(([k,v]) => `<li>${k}: <b>${v}</b></li>`)
            .join("");

          const checked = (opt.idx === b.chosenIndex) ? "checked" : "";
          return `
            <label class="opt" style="display:block;">
              <div style="display:flex; gap:10px; align-items:flex-start;">
                <input type="radio"
                       name="alt_${b.item}"
                       value="${opt.idx}"
                       ${checked}
                       onchange="handleAltChoiceChange('${b.item}', ${opt.idx})" />
                <div style="flex:1;">
                  <div><b>${opt.name}</b></div>
                  <div class="muted">${opt.yield}個/回 → ${opt.craftTimes}回クラフト（必要数 ${b.need}）</div>
                  <ul>${mats}</ul>
                  <div class="muted">この選択の料金：<b>${fmtYen(opt.costYen)}円</b></div>
                </div>
              </div>
            </label>
          `;
        }).join("");

        return `
          <div class="box">
            <div><b>${b.item}</b>（必要数：${b.need}）</div>
            <div class="muted">※ ラジオで採用レシピを選べます（合計は選択した方で計算）</div>
            ${opts}
          </div>
        `;
      }).join("");
    } else {
      altDetails.open = false;
      altEl.innerHTML = `<div class="muted">（代替レシピ対象の素材が、今は必要ありません）</div>`;
    }
  }

  // 右上メモ
  const enteredCount = Object.values(counts).filter(v => (v||0) > 0).length;
  if (resultNote) resultNote.textContent = enteredCount ? `入力中：${enteredCount}件` : "";

  renderCraftTree();

}

function buildCraftTree(itemName, qty, depth = 0, visited = new Set()){
  // ループ防止
  const key = `${itemName}`;
  if (visited.has(key)) return "";
  visited.add(key);

  const recipe = RECIPES[itemName];
  if (!recipe) return ""; // レシピなしはツリー化しない（親側でleaf表示）

  let html = `<details ${depth===0 ? "open" : ""}>
    <summary>
      <div class="treeItem">
        <span>${itemName}</span>
        <span class="treeQty">×${qty}</span>
      </div>
    </summary>
  `;

  for (const [mat, per] of Object.entries(recipe)){
    const total = per * qty;

    // mat がクラフト可能なら「行」じゃなくてそのまま子ノードにする
    if (RECIPES[mat]) {
      html += buildCraftTree(mat, total, depth + 1, new Set(visited));
    } else {
      html += `
        <div class="treeItem" style="margin-left:10px;">
          <span>${mat}</span>
          <span class="treeQty">×${total}</span>
        </div>
      `;
    }
  }

  html += `</details>`;
  return html;
}


    function renderCraftTree(){
  const el = document.getElementById("craftTree");
  if (!el) return;

  const roots = Object.entries(counts)
    .filter(([_, qty]) => (qty || 0) > 0)
    // 表示順を安定させる（任意：名前順）
    .sort(([a],[b]) => a.localeCompare(b, "ja"));

  const chunks = [];
  for (const [item, qty] of roots){
    if (!RECIPES[item]) continue;      // レシピがある完成品だけツリー化
    chunks.push(buildCraftTree(item, qty));
  }

  el.innerHTML = chunks.length
    ? chunks.join("")
    : `<div class="muted">（まだ入力がありません）</div>`;
}



/* =======================
   イベント
======================= */

// ページ切替（タブ）
if (tabCraft) tabCraft.addEventListener("click", () => setPage("craft"));
if (tabCrime) tabCrime.addEventListener("click", () => setPage("crime"));

// 犯罪ページ
if (crimeMethod) crimeMethod.addEventListener("change", () => {
  if (crimeSingleMode?.checked){
    selectedCrimes.length = 0;
    selectedCrimes.push({
      name: crimeSelect.value,
      method: crimeMethod.value,
      times: Math.max(1, Number(crimeTimes?.value || 1) || 1)
    });
  }
  renderCrimePlan();
  renderCrimeItems();
});

if (crimeTimes) crimeTimes.addEventListener("input", () => {
  if (crimeSingleMode?.checked){
    const name = crimeSelect?.value;
    const times = Math.max(1, Number(crimeTimes.value || 1) || 1);
    selectedCrimes.length = 0;
    if (name) selectedCrimes.push({ name, times });
  }
  renderCrimePlan();
  renderCrimeItems();
});
if (crimeIncludeMaterials) crimeIncludeMaterials.addEventListener("change", () => {
  renderCrimePlan();
  renderCrimeItems();
});
if (crimeSingleMode) crimeSingleMode.addEventListener("change", () => {
  const name = crimeSelect?.value;
  const times = Math.max(1, Number(crimeTimes?.value || 1) || 1);
  selectedCrimes.length = 0;
  if (name) selectedCrimes.push({ name, times });
  renderCrimePlan();
  renderCrimeItems();
});
if (addCrimeBtn) addCrimeBtn.addEventListener("click", () => {
  const name = crimeSelect?.value;
  if (!name) return;
  const times = Math.max(1, Number(crimeTimes?.value || 1) || 1);
  selectedCrimes.push({ name, times });
  renderCrimePlan();
  renderCrimeItems();
});
if (clearCrimeBtn) clearCrimeBtn.addEventListener("click", () => clearCrimePlan());

/* =======================
   ★ クラフトへ反映ボタン
======================= */

const applyCrimeToCraftBtn = $("applyCrimeToCraftBtn");
const applyCrimeToCraftAddBtn = $("applyCrimeToCraftAddBtn");

if (applyCrimeToCraftBtn){
  applyCrimeToCraftBtn.addEventListener("click", () => {
    applyCrimeToCraft({ mode: "replace" });
  });
}

if (applyCrimeToCraftAddBtn){
  applyCrimeToCraftAddBtn.addEventListener("click", () => {
    applyCrimeToCraft({ mode: "add" });
  });
}

if (searchBox) searchBox.addEventListener("input", () => { renderItems(); saveStateDebounced(); });
if (showOnlyFav) showOnlyFav.addEventListener("change", () => { renderItems(); saveStateDebounced(); });
if (showOnlyEntered) showOnlyEntered.addEventListener("change", () => { renderItems(); saveStateDebounced(); });
if (pinEntered) pinEntered.addEventListener("change", () => { renderItems(); saveStateDebounced(); });
if (resetBtn) {
  resetBtn.addEventListener("click", () => {
    if (!confirm("入力をすべてリセットしますか？")) return;

    for (const k of Object.keys(counts)) {
      counts[k] = 0;
    }

    renderItems();
    saveStateDebounced();
  });
}


/* =======================
   初期表示
======================= */
renderCrimeSelect();

// ★ 追加：復元（描画前）
restoreState();

// ★ 最後に開いてたページを優先
setPage(currentPage || "craft");

renderCategorySeg();
renderItems();

// ★ 初回描画後に保存（念のため）
saveStateDebounced();

</script>
</body>
</html>